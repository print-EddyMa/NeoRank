name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      - name: Lint (flake8)
        run: flake8 . --count --show-source --statistics || true
      - name: Test
        run: pytest -q
      - name: Smoke integration (fast train)
        run: |
          python - <<'PY'
from neorank import NeoRankTrainer
from neorank import Config

cfg = Config()
# reduce model complexity for smoke test
cfg.N_ESTIMATORS = 10
cfg.N_CV_FOLDS = 2

# create tiny synthetic example files
import pandas as pd, tempfile

ef = pd.DataFrame({
    'Epitope ID - IEDB IRI': ['IEDB:1','IEDB:2','IEDB:3'],
    'Epitope - Name': ['SIINFEKL','KVAELVHFL','GILGFVFTL']
})
tf = pd.DataFrame({
    'Epitope - IEDB IRI': ['IEDB:1','IEDB:2','IEDB:3'],
    'Assay - Qualitative Measurement': ['Positive','Negative','Positive'],
    'MHC Restriction - Name': ['HLA-A*02:01','HLA-A*02:01','HLA-A*02:01']
})

with tempfile.TemporaryDirectory() as tmp:
    ef.to_csv(tmp + '/epitope.tsv', sep='\t', index=False)
    tf.to_csv(tmp + '/tcell.tsv', sep='\t', index=False)
    trainer = NeoRankTrainer(epitope_file=tmp + '/epitope.tsv', tcell_file=tmp + '/tcell.tsv', config=cfg)
    model_data = trainer.run(save_model_path=tmp + '/model.pkl', save_results_path=tmp + '/cv.csv')
    print('Smoke train finished')
PY
